# 工作流 (Workflow) 功能详解

工作流是动态按钮插件 1.2.0 版本引入的核心功能，它提供了一个强大的可视化编排工具，允许您将多个独立的“动作”连接成一个复杂的、自动化的任务序列。

## 1. 什么是工作流？

您可以将工作流想象成一个流程图。在这个图中，每一个“节点”（Node）代表一个具体的操作（例如，发送一次 HTTP 请求、执行一段本地 Python 代码、或者调用一个模块动作），而连接节点的“边”（Edge）则定义了这些操作的执行顺序和数据流动方向。

当一个工作流被触发时，插件的执行引擎会像执行流程图一样，按照您定义的顺序和逻辑，一步步地完成所有节点的操作。

核心特性：

-   **可视化编排**：您可以在 WebUI 中通过拖拽的方式来创建和编辑工作流，非常直观。
-   **数据传递**：一个节点的输出（例如，从 API 获取的数据）可以作为后续节点的输入，实现了动作之间的数据共享和加工。
-   **逻辑复用**：创建好的工作流可以被任何按钮或菜单触发，实现了复杂逻辑的统一管理和复用。
-   **强大的扩展性**：工作流可以整合所有类型的动作，包括 HTTP 动作、本地动作以及新的模块化动作，扩展性极强。

## 2. 核心概念

-   **节点 (Node)**
    -   工作流中的基本执行单元。
    -   每个节点都绑定了一个具体的**动作 (Action)**。
    -   当工作流执行到该节点时，它所绑定的动作就会被执行。
    -   节点可以有多个输入端口和输出端口，用于接收和传递数据。

-   **边 (Edge)**
    -   连接两个节点的有向线段，定义了数据的流向和执行的依赖关系。
    -   一条边从源节点的**输出端口**连接到目标节点的**输入端口**。
    -   这意味着，源节点的某个输出值，将被用作目标节点的某个输入参数。
    -   **重要**：工作流是一个**有向无环图 (DAG)**，您不能创建循环依赖（例如，A→B→A），否则执行会失败。

-   **输入/输出 (Inputs/Outputs)**
    -   **输入**：一个动作执行时所需要的参数。在工作流中，这些参数的值可以被**写死**（在节点的设置面板中直接填写），也可以通过**边**从上游节点动态获取。
    -   **输出**：一个动作执行成功后产生的结果。这些结果可以被后续节点用作输入。

## 3. 工作原理

当一个工作流被触发时，`ActionExecutor` 会执行以下步骤：

1.  **加载定义**：从 `buttons_state.json` 文件中加载工作流的完整定义（所有节点和边）。
2.  **构建图并排序**：在内存中构建一个有向图，并使用**拓扑排序**算法（Kahn's Algorithm）来确定所有节点的正确执行顺序。这一步也会检测是否存在循环依赖。
3.  **顺序执行节点**：
    -   按照排好的顺序，依次执行每个节点所代表的动作。
    -   在执行一个节点前，它会先收集合适的输入参数：
        -   一部分可能是在 WebUI 中为该节点静态配置的。
        -   另一部分则根据“边”的定义，从已经执行完毕的上游节点的输出结果中获取。
    -   执行当前节点动作。
4.  **存储输出**：节点执行成功后，其输出变量会被记录下来，以供后续节点使用。
5.  **聚合结果**：
    -   工作流会将所有执行过的、且产生了 `new_text` 的节点的文本结果，用换行符连接起来，作为最终的返回消息。
    -   其他的 UI 效果（如跳转菜单、显示通知等）则以**最后一个**成功执行的节点的结果为准。

## 4. 如何创建和使用

目前，工作流的创建和编辑完全通过 **WebUI** 进行。

### 基本流程

1.  登录 WebUI。
2.  导航到“工作流”管理页面。
3.  点击“新建工作流”，进入可视化编辑器。
4.  从右侧的动作列表中，将您需要的动作拖拽到画布上，成为一个新的节点。
5.  拖动节点的输出端口（右侧）到另一个节点的输入端口（左侧），创建一条“边”，以实现数据传递。
6.  完成编排后，保存工作流。
7.  最后，在任何一个按钮或菜单的配置中，将其动作类型选为“工作流”，并指定您刚刚创建的工作流 ID 即可。

### 编辑器操作技巧

*   **编辑节点**：在画布上，**双击**任何一个节点，可以打开该节点的配置菜单，用于设置其绑定的动作和静态输入参数。
*   **删除节点或连接线**：在画布上，**右键点击**一个节点或一条连接线，会弹出一个×，选择“删除”即可将其移除。
